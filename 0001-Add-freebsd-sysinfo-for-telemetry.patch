From dcdb07688f1957d070c1a5ac2f7c56ab5f5f2b6a Mon Sep 17 00:00:00 2001
From: Patrick McEvoy <patrick.mcevoy@gmail.com>
Date: Thu, 20 Mar 2025 16:15:52 +0000
Subject: [PATCH] Add freebsd sysinfo for telemetry

---
 substrate/client/sysinfo/src/lib.rs           |  2 +
 substrate/client/sysinfo/src/sysinfo.rs       |  3 ++
 .../client/sysinfo/src/sysinfo_freebsd.rs     | 49 +++++++++++++++++++
 3 files changed, 54 insertions(+)
 create mode 100644 substrate/client/sysinfo/src/sysinfo_freebsd.rs

diff --git a/substrate/client/sysinfo/src/lib.rs b/substrate/client/sysinfo/src/lib.rs
index 7bc30ae022..21eff645d5 100644
--- a/substrate/client/sysinfo/src/lib.rs
+++ b/substrate/client/sysinfo/src/lib.rs
@@ -25,6 +25,8 @@ use std::time::Duration;
 mod sysinfo;
 #[cfg(target_os = "linux")]
 mod sysinfo_linux;
+#[cfg(target_os = "freebsd")]
+mod sysinfo_freebsd;
 
 pub use sysinfo::{
 	benchmark_cpu, benchmark_cpu_parallelism, benchmark_disk_random_writes,
diff --git a/substrate/client/sysinfo/src/sysinfo.rs b/substrate/client/sysinfo/src/sysinfo.rs
index 4bcdd67345..824e950da1 100644
--- a/substrate/client/sysinfo/src/sysinfo.rs
+++ b/substrate/client/sysinfo/src/sysinfo.rs
@@ -317,6 +317,9 @@ pub fn gather_sysinfo() -> SysInfo {
 	#[cfg(target_os = "linux")]
 	crate::sysinfo_linux::gather_linux_sysinfo(&mut sysinfo);
 
+	#[cfg(target_os = "freebsd")]
+	crate::sysinfo_freebsd::gather_freebsd_sysinfo(&mut sysinfo);
+
 	sysinfo
 }
 
diff --git a/substrate/client/sysinfo/src/sysinfo_freebsd.rs b/substrate/client/sysinfo/src/sysinfo_freebsd.rs
new file mode 100644
index 0000000000..27ff6ab680
--- /dev/null
+++ b/substrate/client/sysinfo/src/sysinfo_freebsd.rs
@@ -0,0 +1,49 @@
+// This file is part of Substrate.
+
+// Copyright (C) Parity Technologies (UK) Ltd.
+// SPDX-License-Identifier: GPL-3.0-or-later WITH Classpath-exception-2.0
+
+// This program is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+
+// This program is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+// GNU General Public License for more details.
+
+// You should have received a copy of the GNU General Public License
+// along with this program. If not, see <https://www.gnu.org/licenses/>.
+
+use sc_telemetry::SysInfo;
+use std::process::Command;
+use std::str;
+
+fn sysctl_output(name: &str) -> Option<String> {
+    let output = Command::new("sysctl").arg("-n").arg(name).output().ok()?;
+    let stdout = String::from_utf8_lossy(&output.stdout).trim().to_string();
+    Some(stdout)
+}
+
+pub fn gather_freebsd_sysinfo(sysinfo: &mut SysInfo) {
+    if let Some(cpu_model) = sysctl_output("hw.model") {
+        sysinfo.cpu = Some(cpu_model);
+    }
+
+    if let Some(cores) = sysctl_output("hw.ncpu") {
+        sysinfo.core_count = cores.parse().ok();
+    }
+
+    if let Some(memory) = sysctl_output("hw.physmem") {
+        sysinfo.memory = memory.parse().ok();
+    }
+
+    if let Some(virtualization) = sysctl_output("kern.vm_guest") {
+        sysinfo.is_virtual_machine = Some(virtualization != "none");
+    }
+
+    if let Some(freebsd_version) = sysctl_output("kern.osrelease") {
+        sysinfo.linux_distro = Some(freebsd_version);
+    }
+}
-- 
2.48.1

